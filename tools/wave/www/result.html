<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Results - Web Platform Test</title>
    <link rel="stylesheet" href="css/bulma-0.7.4/bulma.min.css" />
    <link rel="stylesheet" href="css/fontawesome-5.7.2.min.css" />
    <link rel="stylesheet" href="css/result.css" />
    <script src="lib/jszip.min.js"></script>
    <script src="lib/utils.js"></script>
    <script src="lib/wave-service.js"></script>
    <script src="lib/ui.js"></script>
  </head>
  <body>
    <script>
      window.onload = () => {
        const query = utils.parseQuery(location.search);
        const token = query.token;
        if (token) {
          WaveService.setDefaultToken(token);
          resultUi.render();
          resultUi.refreshData();
        } else {
          location.href = "/results.html" + location.search;
        }

        if (window.localStorage) {
          const storage = window.localStorage;
          let state = JSON.parse(storage.getItem("wave"));
          if (!state) {
            state = {};
          }
          if (!state.recent_sessions) {
            state.recent_sessions = [];
          }
          const index = state.recent_sessions.indexOf(token);
          if (index !== -1) state.recent_sessions.splice(index, 1);
          state.recent_sessions.unshift(token);
          storage.setItem("wave", JSON.stringify(state));
        }
      };

      const resultUi = {
        state: {},
        refreshData: toUpdate => {
          WaveService.getSessionDetails(details => {
            WaveService.getTestResults(results => {
              Object.keys(details.test_files_count).forEach(api =>
                !results[api] ? (results[api] = {}) : null
              );
              for (let api in results) {
                let { pass, fail, timeout, not_run } = results[api];
                let complete = 0;
                if (pass) complete += pass;
                if (fail) complete += fail;
                if (timeout) complete += timeout;
                if (not_run) complete += not_run;
                results[api].complete = complete;
                const { test_files_count, test_files_completed } = details;
                results[api].isDone =
                  test_files_count[api] === test_files_completed[api];
                results[api].testFilesCount = test_files_count[api];
                results[api].testFilesCompleted = test_files_completed[api];
              }

              switch (toUpdate) {
                case "complete":
                  resultUi.displayApiResults(results);
                  break;
                case "status":
                  resultUi.displayControls(details.status);
                  resultUi.displaySessionDetails(details);
                  break;
                case "":
                case null:
                case undefined:
                  resultUi.displayApiResults(results);
                  resultUi.displayControls(details.status);
                  resultUi.displaySessionDetails(details);
                  break;
              }

              if (
                !WaveService.socket &&
                details.status !== "completed" &&
                details.status !== "aborted"
              ) {
                WaveService.connect();
                WaveService.onMessage(message => {
                  resultUi.refreshData(message.data);
                });
              }
            });
          });
        },
        render: () => {
          const { getRoot, createElement } = UI;
          const root = getRoot();
          root.innerHTML = "";
          root.appendChild(
            createElement({
              className: "content",
              children: [
                {
                  className: "header",
                  children: [
                    {
                      children: [
                        {
                          element: "img",
                          src: "res/wavelogo_2016.jpg",
                          className: "site-logo"
                        }
                      ]
                    },
                    {
                      className: "button is-dark is-outlined",
                      onclick: () => (location.href = "/results.html"),
                      children: [
                        {
                          element: "span",
                          className: "icon",
                          children: [
                            {
                              element: "i",
                              className: "fas fa-arrow-left"
                            }
                          ]
                        },
                        {
                          text: "Results Overview",
                          element: "span"
                        }
                      ]
                    }
                  ]
                },
                {
                  id: "header",
                  children: [
                    { className: "title", text: "Result" },
                    { id: "controls-wrapper" }
                  ]
                },
                { text: "Session details", className: "title is-4" },
                { id: "details-table", element: "table" },
                { text: "API Results", className: "title is-4" },
                { id: "api-results" },
                { id: "timeout-files" }
              ]
            })
          );
        },
        displayControls: status => {
          const { getElement, createElement } = UI;
          const controlsWrapper = getElement("controls-wrapper");
          controlsWrapper.innerHTML = "";
          const controls = [];
          if (status !== "aborted" && status !== "completed") {
            controls.push(
              createElement({
                id: "pause-resume-button",
                className: "button is-dark is-outlined",
                style: "margin-right: 20px",
                onclick: function() {
                  if (status === "running") {
                    WaveService.pauseSession(resultUi.refreshData);
                  } else {
                    WaveService.resumeSession(resultUi.refreshData);
                  }
                },
                children: [
                  {
                    element: "span",
                    className: "icon",
                    children: [
                      {
                        element: "i",
                        className:
                          status === "running" ? "fas fa-pause" : "fas fa-play"
                      }
                    ]
                  },
                  {
                    text: status === "running" ? "Pause" : "Resume",
                    element: "span"
                  }
                ]
              })
            );
            controls.push(
              createElement({
                id: "stop-button",
                className: "button is-dark is-outlined",
                onclick: () => {
                  WaveService.stopSession(resultUi.refreshData);
                },
                children: [
                  {
                    element: "span",
                    className: "icon",
                    children: [
                      {
                        element: "i",
                        className: "fas fa-square"
                      }
                    ]
                  },
                  {
                    text: "Stop",
                    element: "span"
                  }
                ]
              })
            );
          }
          controls.push(
            createElement({
              id: "delete-button",
              className: "button is-dark is-outlined",
              style: "margin-left: 20px",
              onclick: () => {
                const modal = UI.getElement("delete-modal");
                let className = modal.getAttribute("class");
                modal.setAttribute("class", className + " is-active");
              },
              children: [
                {
                  element: "span",
                  className: "icon",
                  children: [
                    {
                      element: "i",
                      className: "fas fa-trash-alt"
                    }
                  ]
                },
                {
                  text: "Delete",
                  element: "span"
                }
              ]
            })
          );
          controls.push(
            createElement({
              id: "delete-modal",
              className: "modal",
              children: [
                {
                  className: "modal-background",
                  onclick: () => {
                    const modal = UI.getElement("delete-modal");
                    let className = modal.getAttribute("class");
                    className = className.replace(" is-active", "");
                    modal.setAttribute("class", className);
                  }
                },
                {
                  className: "modal-card",
                  children: [
                    {
                      className: "modal-card-head",
                      children: [
                        {
                          element: "p",
                          className: "modal-card-title",
                          text: "Delete Session"
                        }
                      ]
                    },
                    {
                      className: "modal-card-body",
                      children: [
                        {
                          element: "p",
                          text: "Are you sure you want to delete this session?"
                        },
                        { element: "p", text: "This action cannot be undone." }
                      ]
                    },
                    {
                      className: "modal-card-foot",
                      children: [
                        {
                          className: "button is-danger",
                          text: "Delete Session",
                          onclick: () => {
                            WaveService.deleteSession();
                            document.location = "/results.html";
                          }
                        },
                        {
                          className: "button",
                          text: "Cancel",
                          onclick: () => {
                            const modal = UI.getElement("delete-modal");
                            let className = modal.getAttribute("class");
                            className = className.replace(" is-active", "");
                            modal.setAttribute("class", className);
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            })
          );
          controls.forEach(control => controlsWrapper.appendChild(control));
        },
        displaySessionDetails: details => {
          const { getElement } = UI;
          const { test_files_count } = details;
          const detailsTable = getElement("details-table");
          detailsTable.innerHTML = "";
          const getTagStyle = status => {
            switch (status) {
              case "completed":
                return "is-success";
              case "running":
                return "is-info";
              case "aborted":
                return "is-danger";
              case "paused":
                return "is-warning";
            }
          };
          if (details.date_finished) {
            if (resultUi.state.durationInterval)
              clearInterval(resultUi.state.durationInterval);
          } else {
            if (!resultUi.state.durationInterval)
              resultUi.state.durationInterval = setInterval(() => {
                UI.getElement("duration").innerHTML = utils.millisToTimeString(
                  Date.now() - parseInt(details.date_started)
                );
              }, 1000);
          }

          detailsTable.appendChild(
            UI.createElement({
              element: "tbody",
              children: [
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Token:" },
                    {
                      element: "td",
                      text: WaveService.getDefaultToken() || "",
                      className: "is-family-monospace"
                    }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "User Agent:" },
                    { element: "td", text: details.user_agent || "" }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Test Path:" },
                    { element: "td", text: details.path || "" }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Total Test Files:" },
                    {
                      element: "td",
                      text: Object.keys(test_files_count).reduce(
                        (sum, api) => (sum += test_files_count[api]),
                        0
                      )
                    }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Status:" },
                    {
                      element: "td",
                      children: [
                        {
                          className: `tag ${getTagStyle(details.status)}`,
                          text: details.status
                        }
                      ]
                    }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Test Timeout:" },
                    { element: "td", text: details.test_timeout || "" }
                  ]
                },
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Started:" },
                    {
                      element: "td",
                      text: new Date(details.date_started).toLocaleString()
                    }
                  ]
                },
                details.date_finished
                  ? {
                      element: "tr",
                      children: [
                        { element: "td", text: "Finished:" },
                        {
                          element: "td",
                          text: new Date(details.date_finished).toLocaleString()
                        }
                      ]
                    }
                  : null,
                {
                  element: "tr",
                  children: [
                    { element: "td", text: "Duration:" },
                    {
                      element: "td",
                      id: "duration",
                      text: utils.millisToTimeString(
                        details.date_finished
                          ? parseInt(details.date_finished) -
                              parseInt(details.date_started)
                          : Date.now() - parseInt(details.date_started)
                      )
                    }
                  ]
                }
              ]
            })
          );
        },
        displayApiResults: results => {
          const { getElement, createElement } = UI;
          const resultsTable = {
            element: "table",
            className: "table",
            id: "results-table",
            children: [
              {
                element: "thead",
                children: [
                  {
                    element: "tr",
                    children: [
                      { element: "th", text: "API" },
                      { element: "th", text: "Pass" },
                      { element: "th", text: "Fail" },
                      { element: "th", text: "Timeout" },
                      { element: "th", text: "Not Run" },
                      { element: "th", text: "Test Files Run" },
                      { element: "th", text: "" }
                    ]
                  }
                ]
              }
            ]
          };

          function createApiResultView({
            api,
            complete = 0,
            pass = 0,
            fail = 0,
            timeout = 0,
            timeoutfiles = [],
            not_run: notRun = 0,
            isDone = false,
            testFilesCount,
            testFilesCompleted = 0
          }) {
            const apiName = api instanceof Array ? "Total" : api;
            return {
              element: "tr",
              style: `background-image: linear-gradient(to right, hsl(0, 0%, 86%) ${utils.percent(
                testFilesCompleted,
                testFilesCount
              )}%, white ${utils.percent(
                testFilesCompleted,
                testFilesCount
              )}%)`,
              children: [
                { element: "td", text: apiName },
                {
                  element: "td",
                  style: "color: hsl(141, 71%, 38%)",
                  text: `${pass} (${utils.percent(pass, complete)}%)`
                },
                {
                  element: "td",
                  className: "has-text-danger",
                  text: `${fail} (${utils.percent(fail, complete)}%)`
                },
                {
                  element: "td",
                  style: "color: hsl(48, 100%, 40%)",
                  text: `${timeout} (${utils.percent(timeout, complete)}%)`
                },
                {
                  element: "td",
                  className: "has-text-info",
                  text: `${notRun} (${utils.percent(notRun, complete)}%)`
                },
                {
                  element: "td",
                  className: "",
                  text: `${testFilesCompleted}/${testFilesCount} (${utils.percent(
                    testFilesCompleted,
                    testFilesCount
                  )}%)`
                },
                {
                  element: "td",
                  className: "",
                  children: [
                    {
                      className: "button is-dark is-outlined is-small",
                      disabled: !isDone,
                      onclick: () =>
                        isDone ? WaveService.downloadJson(api) : null,
                      text: "json"
                    },
                    {
                      className: "button is-dark is-outlined is-small",
                      disabled: !isDone,
                      onclick: () => {
                        if (!isDone) return;
                        if (api instanceof Array) {
                        } else {
                          WaveService.openHtmlReport(api);
                        }
                      },
                      text: "report"
                    }
                  ]
                }
              ]
            };
          }

          const apis = Object.keys(results).sort((apiA, apiB) =>
            apiA.toLowerCase() > apiB.toLowerCase() ? 1 : -1
          );

          const tableBody = { element: "tbody", children: [] };

          for (let api of apis) {
            const result = results[api];
            result.api = api;
            const apiResultView = createApiResultView(result);
            tableBody.children.push(apiResultView);
          }
          resultsTable.children.push(tableBody);

          const stats = apis.reduce(
            (sum, api) => {
              Object.keys(sum).forEach(
                key => (sum[key] += results[api][key] ? results[api][key] : 0)
              );
              return sum;
            },
            {
              complete: 0,
              pass: 0,
              fail: 0,
              timeout: 0,
              not_run: 0
            }
          );
          stats.api = apis.filter(api => results[api].isDone);
          stats.timeoutfiles = [];
          stats.isDone = Object.keys(results).some(api => results[api].isDone);
          stats.testFilesCount = Object.keys(results).reduce(
            (sum, api) => (sum += results[api].testFilesCount),
            0
          );
          stats.testFilesCompleted = Object.keys(results).reduce(
            (sum, api) => (sum += results[api].testFilesCompleted || 0),
            0
          );
          const {
            pass,
            fail,
            timeout,
            not_run,
            complete,
            testFilesCount,
            testFilesCompleted,
            isDone,
            api
          } = stats;
          resultsTable.children.push({
            element: "tfoot",
            style: `background-image: linear-gradient(to right, hsl(0, 0%, 86%) ${utils.percent(
              testFilesCompleted,
              testFilesCount
            )}%, white ${utils.percent(testFilesCompleted, testFilesCount)}%)`,
            children: [
              {
                element: "tr",
                children: [
                  { element: "th", text: "Total" },
                  {
                    element: "th",
                    style: "color: hsl(141, 71%, 38%)",
                    text: `${pass} (${utils.percent(pass, complete)}%)`
                  },
                  {
                    element: "th",
                    className: "has-text-danger",
                    text: `${fail} (${utils.percent(fail, complete)}%)`
                  },
                  {
                    element: "th",
                    style: "color: hsl(48, 100%, 40%)",
                    text: `${timeout} (${utils.percent(timeout, complete)}%)`
                  },
                  {
                    element: "th",
                    className: "has-text-info",
                    text: `${not_run} (${utils.percent(not_run, complete)}%)`
                  },
                  {
                    element: "th",
                    text: `${testFilesCompleted}/${testFilesCount} (${utils.percent(
                      testFilesCompleted,
                      testFilesCount
                    )}%)`
                  },
                  {
                    element: "th",
                    children: [
                      {
                        className: "button is-dark is-outlined is-small",
                        disabled: !isDone,
                        onclick: () =>
                          isDone ? WaveService.downloadJsons(api) : null,
                        text: "json"
                      },
                      {
                        className: "button is-dark is-small",
                        text: "html",
                        onclick: () => WaveService.downloadHtmlZip()
                      }
                    ]
                  }
                ]
              }
            ]
          });
          const apiResultsView = getElement("api-results");
          apiResultsView.innerHTML = "";
          apiResultsView.appendChild(createElement(resultsTable));

          const { timeoutfiles } = stats;
          UI.getElement("timeout-files").appendChild(
            createElement({
              className: "api-result-timeoutfiles",
              html: timeoutfiles.reduce(
                (all, file) => (all += file + "<br>"),
                "Test files with timeout:<br>"
              )
            })
          );
        }
      };
    </script>
  </body>
</html>
