<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Compare Results - Web Platform Test</title>
    <link rel="stylesheet" href="css/bulma-0.7.4/bulma.min.css" />
    <link rel="stylesheet" href="css/fontawesome-5.7.2.min.css" />
    <script src="lib/utils.js"></script>
    <script src="lib/wave-service.js"></script>
    <script src="lib/ui.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        font-family: "Noto Sans", sans-serif;
        overflow-y: auto;
        overflow-x: hidden;
        background-color: white;
        color: #000;
      }

      .site-logo {
        max-width: 300px;
        margin-left: -15px;
      }

      .content {
        width: 1000px;
      }

      .header {
        display: flex;
        margin: 50px 0 30px 0;
      }

      .header :first-child {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <script>
      window.onload = () => {
        let { tokens, reftokens } = utils.parseQuery(location.search);
        tokens = tokens ? tokens.split(",") : [];
        const refTokens = reftokens ? reftokens.split(",") : [];
        if (tokens) {
          WaveService.addRecentSessions(tokens);
          WaveService.addRecentSessions(refTokens);
          comparisonUi.state.tokens = tokens;
          comparisonUi.state.refTokens = refTokens;
          comparisonUi.render();
          comparisonUi.refreshData();
        }
      };

      const comparisonUi = {
        state: {
          tokens: [],
          refTokens: [],
          sessions: {}
        },
        refreshData: () => {
          const { tokens, refTokens } = comparisonUi.state;
          const allTokens = tokens.slice();
          refTokens
            .filter(token => allTokens.indexOf(token) === -1)
            .forEach(token => allTokens.push(token));

          WaveService.getSessionDetails(allTokens, sessionDetails => {
            const sessions = {};
            sessionDetails.forEach(
              details => (sessions[details.token] = details)
            );
            comparisonUi.state.sessions = sessions;

            WaveService.getFilteredTestResults(tokens, refTokens, results => {
              comparisonUi.state.results = results;
              comparisonUi.renderApiResults();
            });

            const sessionsReferenceTokens = [];
            sessionDetails.forEach(({ reference_tokens }) =>
              reference_tokens
                .filter(token => refTokens.indexOf(token) === -1)
                .filter(token => sessionsReferenceTokens.indexOf(token) === -1)
                .forEach(token => sessionsReferenceTokens.push(token))
            );

            sessionsReferenceTokens.forEach(token =>
              comparisonUi.state.refTokens.push(token)
            );

            WaveService.getSessionDetails(
              sessionsReferenceTokens,
              sessionDetails => {
                const { sessions } = comparisonUi.state;
                sessionDetails.forEach(
                  details => (sessions[details.token] = details)
                );
                comparisonUi.renderDetails();
              }
            );
          });
        },
        openResultsOverview() {
          location.href = "/results.html";
        },
        render() {
          const comparisonView = UI.createElement({
            className: "content",
            style: "margin-bottom: 40px;",
            children: [
              {
                className: "header",
                children: [
                  {
                    children: [
                      {
                        element: "img",
                        src: "res/wavelogo_2016.jpg",
                        className: "site-logo"
                      }
                    ]
                  },
                  {
                    className: "button is-dark is-outlined",
                    onClick: comparisonUi.openResultsOverview,
                    children: [
                      {
                        element: "span",
                        className: "icon",
                        children: [
                          {
                            element: "i",
                            className: "fas fa-arrow-left"
                          }
                        ]
                      },
                      {
                        text: "Results Overview",
                        element: "span"
                      }
                    ]
                  }
                ]
              },
              {
                id: "header",
                children: [
                  { className: "title", text: "Comparison" },
                  { id: "controls" }
                ]
              },
              { id: "details" },
              { id: "api-results" }
            ]
          });

          const root = UI.getRoot();
          root.innerHTML = "";
          root.appendChild(comparisonView);
          comparisonUi.renderDetails();
          comparisonUi.renderApiResults();
        },
        renderDetails() {
          const detailsView = UI.createElement({
            style: "margin-bottom: 20px"
          });

          const { refTokens } = comparisonUi.state;
          const detailsTable = UI.createElement({
            element: "table",
            children: {
              element: "tbody",
              children: [
                {
                  element: "tr",
                  children: [
                    {
                      element: "td",
                      text: "Reference Sessions:",
                      style: "width: 175px"
                    },
                    { element: "td", id: "reference-sessions" }
                  ]
                }
              ]
            }
          });
          detailsView.appendChild(detailsTable);

          const details = UI.getElement("details");
          details.innerHTML = "";
          details.appendChild(detailsView);
          comparisonUi.renderReferenceSessions();
        },
        renderReferenceSessions() {
          const { sessions, refTokens } = comparisonUi.state;
          if (!Object.keys(sessions) || Object.keys(sessions).length === 0)
            return;
          const referenceSessions = refTokens.map(token => sessions[token]);
          const referenceSessionsTarget = UI.getElement("reference-sessions");
          referenceSessionsTarget.innerHTML = "";
          const getBrowserIcon = browser => {
            switch (browser.toLowerCase()) {
              case "firefox":
                return "fab fa-firefox";
              case "edge":
                return "fab fa-edge";
              case "chrome":
              case "chromium":
                return "fab fa-chrome";
              case "safari":
              case "webkit":
                return "fab fa-safari";
            }
          };
          referenceSessions.forEach(session => {
            const { token, browser } = session;
            const referenceSessionItem = UI.createElement({
              style: "margin-right: 10px",
              className: "button is-dark is-small is-rounded is-outlined",
              onClick: () => WaveService.openSession(token),
              children: [
                {
                  element: "span",
                  className: "icon",
                  children: {
                    element: "i",
                    className: getBrowserIcon(browser.name)
                  }
                },
                {
                  element: "span",
                  className: "is-family-monospace",
                  text: token.split("-").shift()
                }
              ]
            });
            referenceSessionsTarget.appendChild(referenceSessionItem);
          });
        },
        renderApiResults() {
          const apiResultsView = UI.createElement({
            style: "margin-bottom: 20px"
          });

          const heading = UI.createElement({
            className: "title is-4",
            text: "Results"
          });
          apiResultsView.appendChild(heading);

          const { results, tokens, sessions } = comparisonUi.state;

          if (!results) {
            const loadingIndicator = UI.createElement({
              className: "level",
              children: {
                element: "span",
                className: "level-item icon",
                children: [
                  {
                    element: "i",
                    className: "fas fa-spinner fa-pulse"
                  },
                  {
                    style: "margin-left: 0.4em;",
                    text: "Loading results ..."
                  }
                ]
              }
            });
            apiResultsView.appendChild(loadingIndicator);

            const apiResults = UI.getElement("api-results");
            apiResults.innerHTML = "";
            apiResults.appendChild(apiResultsView);
            return;
          }

          const resultsTable = UI.createElement({
            element: "table"
          });
          apiResultsView.appendChild(resultsTable);

          const resultsTableHeader = UI.createElement({
            element: "thead",
            children: {
              element: "tr",
              children: [
                {
                  element: "td",
                  text: "API",
                  style: "vertical-align: bottom; width: 200px"
                }
              ]
                .concat(
                  tokens.map(token => ({
                    element: "td",
                    children: {
                      className: "button is-white",
                      onClick: () => WaveService.openSession(token),
                      text: `${token.split("-").shift()}\n${
                        sessions[token].browser.name
                      } ${sessions[token].browser.version}`
                    }
                  }))
                )
                .concat([{ element: "td", style: "width: 80px" }])
            }
          });
          resultsTable.appendChild(resultsTableHeader);

          let apis = [];
          tokens.forEach(token =>
            Object.keys(results[token])
              .filter(api => apis.indexOf(api) === -1)
              .forEach(api => apis.push(api))
          );
          apis = apis.sort((apiA, apiB) =>
            apiA.toLowerCase() > apiB.toLowerCase() ? 1 : -1
          );

          const resultsTableBody = UI.createElement({
            element: "tbody",
            children: apis.map(api => ({
              element: "tr",
              children: [{ element: "td", text: api }]
                .concat(
                  tokens.map(token => ({
                    element: "td",
                    text: `${utils.percent(
                      results[token][api].passed,
                      results[token][api].total
                    )}%`
                  }))
                )
                .concat([
                  {
                    element: "td",
                    children: {
                      className:
                        "html-report button is-dark is-outlined is-small",
                      onclick: () =>
                        WaveService.openHtmlReport(
                          comparisonUi.state.tokens,
                          api,
                          comparisonUi.state.reftoken
                        ),
                      text: "report"
                    }
                  }
                ])
            }))
          });
          resultsTable.appendChild(resultsTableBody);

          const apiResults = UI.getElement("api-results");
          apiResults.innerHTML = "";
          apiResults.appendChild(apiResultsView);
        }
      };
    </script>
  </body>
</html>
