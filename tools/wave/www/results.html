<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Results - Web Platform Test</title>
    <link rel="stylesheet" href="css/bulma-0.7.4/bulma.min.css" />
    <link rel="stylesheet" href="css/fontawesome-5.7.2.min.css" />
    <script src="lib/utils.js"></script>
    <script src="lib/wave-service.js"></script>
    <script src="lib/ui.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        font-family: "Noto Sans" sans-serif;
        overflow-y: auto;
        overflow-x: hidden;
        background-color: white;
        color: #000;
      }

      .site-logo {
        max-width: 300px;
        margin: 50px 0 30px -15px;
      }

      .content {
        width: 1000px;
        padding: 0 10px;
      }
    </style>
  </head>
  <body>
    <script>
      window.onload = () => {
        const query = utils.parseQuery(location.search);
        if (query.token) {
          location.href = "result.html" + location.search;
        }
        resultsUi.render();
      };

      const resultsUi = {
        state: {
          comparison: []
        },
        addSession() {
          const tokenFragmentInput = UI.getElement("token-fragment");
          const fragment = tokenFragmentInput.value;
          if (!fragment || fragment.length < 8) return;
          WaveService.findToken(fragment, token => {
            if (token) {
              WaveService.addRecentSession(token);
              WaveService.addPinnedSession(token);
              resultsUi.renderSessions();
              tokenFragmentInput.value = "";
            } else {
              const errorBox = getElement("find-error");
              errorBox.setAttribute("style", "display: block");
            }
          });
        },
        render: () => {
          const { getRoot, createElement, getElement } = UI;
          getRoot().appendChild(
            createElement({
              className: "content",
              children: [
                {
                  element: "img",
                  src: "res/wavelogo_2016.jpg",
                  className: "site-logo"
                },
                { text: "Results", className: "title" },
                { text: "Manage Sessions", className: "title is-4" },
                {
                  className: "columns",
                  children: [
                    {
                      className: "column",
                      children: [
                        { text: "Add Sessions", className: "title is-5" },
                        {
                          element: "article",
                          className: "message is-danger",
                          id: "find-error",
                          children: [
                            {
                              text:
                                "Could not find any sessions! Try adding more characters of the token.",
                              className: "message-body"
                            }
                          ],
                          style: "display: none"
                        },
                        {
                          element: "label",
                          text: "Session token:"
                        },
                        {
                          style: "display: flex; margin-bottom: 10px;",
                          children: [
                            {
                              element: "input",
                              inputType: "text",
                              className: "input is-family-monospace",
                              id: "token-fragment",
                              placeholder:
                                "First 8 characters or more of session token",
                              onKeyDown: event => {
                                if (event.key !== "Enter") return;
                                resultsUi.addSession();
                              }
                            }
                          ]
                        },
                        {
                          style: "text-align: right",
                          children: [
                            {
                              className: "button is-dark is-outlined",
                              children: [
                                {
                                  element: "span",
                                  className: "icon",
                                  children: [
                                    {
                                      element: "i",
                                      className: "fas fa-plus"
                                    }
                                  ]
                                },
                                { text: "Add Session", element: "span" }
                              ],
                              style: "margin-left: 20px",
                              onclick: () => {
                                resultsUi.addSession();
                              }
                            }
                          ]
                        }
                        // {
                        //   className: "button is-dark is-outlined",
                        //   text: "View Results",
                        //   onclick: () => {
                        //     const fragment = getElement("token-fragment").value;
                        //     if (!fragment || fragment.length < 8) return;
                        //     WaveService.findToken(fragment, token => {
                        //       if (token) {
                        //         location.href = "/result.html?token=" + token;
                        //       } else {
                        //         const errorBox = getElement("find-error");
                        //         errorBox.setAttribute(
                        //           "style",
                        //           "display: block"
                        //         );
                        //       }
                        //     });
                        //   }
                        // }
                      ]
                    },
                    {
                      className: "column",
                      children: [
                        { text: "Compare Sessions", className: "title is-5" },
                        {
                          element: "label",
                          text: "Session token as reference (optional):"
                        },
                        {
                          style: "display: flex; margin-bottom: 10px",
                          children: [
                            {
                              element: "input",
                              className: "input is-family-monospace",
                              style: "flex: 1;",
                              id: "token-reference",
                              placeholder:
                                "First 8 characters or more of session token"
                            }
                          ]
                        },
                        {
                          style: "text-align: right",
                          children: [
                            {
                              className: "button is-dark is-outlined",
                              disabled: true,
                              id: "compare-button",
                              children: [
                                {
                                  element: "span",
                                  className: "icon",
                                  children: [
                                    {
                                      element: "i",
                                      className: "fas fa-balance-scale"
                                    }
                                  ]
                                },
                                { text: "Compare Selected", element: "span" }
                              ],
                              onclick: () => {
                                if (
                                  UI.getElement("compare-button").hasAttribute(
                                    "disabled"
                                  )
                                )
                                  return;
                                const reftoken = UI.getElement(
                                  "token-reference"
                                ).value;
                                resultsUi.compareSessions(
                                  resultsUi.state.comparison,
                                  reftoken
                                );
                              }
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },

                { id: "sessions" }
              ]
            })
          );
          resultsUi.renderSessions();
        },
        renderSessions() {
          const sessionsView = UI.getElement("sessions");
          sessionsView.innerHTML = "";
          sessionsView.appendChild(
            UI.createElement({ text: "Sessions", className: "title is-4" })
          );
          const pinnedSessions = WaveService.getPinnedSessions();
          const recentSessions = WaveService.getRecentSessions();

          WaveService.getSessionDetails(recentSessions, sessionDetails => {
            recentSessions
              .filter(
                token =>
                  !sessionDetails
                    .filter(details => !!details)
                    .some(session => session.token === token)
              )
              .forEach(token => WaveService.removeRecentSession(token));
            sessionDetails = sessionDetails
              .filter(session => !!session)
              .sort(
                (sessionA, sessionB) =>
                  sessionB.date_started - sessionA.date_started
              );
            const pinnedSessionsView = resultsUi.createPinnedSessionsView(
              sessionDetails.filter(
                session => pinnedSessions.indexOf(session.token) !== -1
              )
            );
            sessionsView.appendChild(pinnedSessionsView);

            const recentSessionsView = resultsUi.createRecentSessionsView(
              sessionDetails.filter(
                session => pinnedSessions.indexOf(session.token) === -1
              )
            );
            sessionsView.appendChild(recentSessionsView);
          });
        },
        createPinnedSessionsView(sessions) {
          const pinnedSessionsView = UI.createElement();
          if (!sessions || sessions.length === 0) return pinnedSessionsView;
          pinnedSessionsView.appendChild(
            UI.createElement({ text: "Pinned", className: "title is-5" })
          );
          pinnedSessionsView.appendChild(
            resultsUi.createSessionsTable(sessions, true)
          );
          pinnedSessionsView.appendChild(
            UI.createElement({ style: "content: ''; margin-bottom: 40px" })
          );
          return pinnedSessionsView;
        },
        createRecentSessionsView(sessions) {
          const recentSessionsView = UI.createElement();
          if (!sessions || sessions.length === 0) return recentSessionsView;
          recentSessionsView.appendChild(
            UI.createElement({ text: "Recent", className: "title is-5" })
          );
          recentSessionsView.appendChild(
            resultsUi.createSessionsTable(sessions, false)
          );
          recentSessionsView.appendChild(
            UI.createElement({ style: "content: ''; margin-bottom: 40px" })
          );
          return recentSessionsView;
        },
        createSessionsTable(sessions, pinned) {
          const getTagStyle = status => {
            switch (status) {
              case "completed":
                return "is-success";
              case "running":
                return "is-info";
              case "aborted":
                return "is-danger";
              case "paused":
                return "is-warning";
            }
          };
          return UI.createElement({
            element: "table",
            className: "table is-bordered is-hoverable is-fullwidth",
            children: [
              {
                element: "tbody",
                children: sessions.map(session => ({
                  element: "tr",
                  style: "cursor: pointer",
                  onclick: () => {
                    location.href = `result.html?token=${session.token}`;
                  },
                  children: [
                    {
                      element: "td",
                      onclick: event => event.stopPropagation(),
                      style: "text-align: center;",
                      children: [
                        {
                          element: "input",
                          className: "checkbox",
                          style:
                            "width: 18px; height: 18px; vertical-align: middle;",
                          type: "checkbox",
                          onchange: event => {
                            if (event.target.checked) {
                              resultsUi.addSessionToComparison(session.token);
                            } else {
                              resultsUi.removeSessionFromComparison(
                                session.token
                              );
                            }
                          }
                        }
                      ]
                    },
                    {
                      element: "td",
                      className: "is-family-monospace",
                      style: "vertical-align: middle;",
                      text: session.token.split("-").shift()
                    },
                    {
                      element: "td",
                      style: "vertical-align: middle",
                      text: session.browser.name + " " + session.browser.version
                    },
                    {
                      element: "td",
                      style: "vertical-align: middle; text-align: center",
                      children: [
                        {
                          className: `tag ${getTagStyle(session.status)}`,
                          text: session.status
                        }
                      ]
                    },
                    {
                      element: "td",
                      style: "vertical-align: middle",
                      text: `${session.user_agent.substr(0, 30)} ...`,
                      title: session.user_agent
                    },
                    {
                      element: "td",
                      text: new Date(session.date_started).toLocaleString()
                    },
                    {
                      element: "td",
                      style: "vertical-align: middle; text-align: center",
                      className: "is-paddingless",
                      children: [
                        {
                          className: "button is-dark is-outlined is-small",
                          style: "margin: 5px",
                          children: [
                            {
                              element: "span",
                              className: "icon",
                              children: [
                                {
                                  element: "i",
                                  className: "fas fa-thumbtack",
                                  style: pinned
                                    ? ""
                                    : "transform: rotate(45deg)"
                                }
                              ]
                            }
                          ],
                          onclick: event => {
                            event.stopPropagation();
                            if (pinned) {
                              WaveService.removePinnedSession(session.token);
                              resultsUi.renderSessions();
                            } else {
                              WaveService.addPinnedSession(session.token);
                              resultsUi.renderSessions();
                            }
                          }
                        }
                      ]
                    },
                    {
                      element: "td",
                      style: "vertical-align: middle; text-align: center",
                      className: "is-paddingless",
                      children: [
                        {
                          className: "button is-dark is-outlined is-small",
                          style: "margin: 5px",
                          children: [
                            {
                              element: "span",
                              className: "icon",
                              children: [
                                { element: "i", className: "fas fa-trash-alt" }
                              ]
                            }
                          ],
                          onclick: event => {
                            event.stopPropagation();
                            WaveService.removeRecentSession(session.token);
                            resultsUi.renderSessions();
                          }
                        }
                      ]
                    }
                  ]
                }))
              }
            ]
          });
        },
        addSessionToComparison: token => {
          if (resultsUi.state.comparison.indexOf(token) !== -1) return;
          resultsUi.state.comparison.push(token);
          resultsUi.updateCompareButton();
        },
        removeSessionFromComparison: token => {
          const index = resultsUi.state.comparison.indexOf(token);
          if (index === -1) return;
          resultsUi.state.comparison.splice(index, 1);
          resultsUi.updateCompareButton();
        },
        updateCompareButton: () => {
          const compareButton = UI.getElement("compare-button");
          if (resultsUi.state.comparison.length > 0) {
            compareButton.removeAttribute("disabled");
          } else {
            compareButton.setAttribute("disabled", true);
          }
        },
        compareSessions: (tokens, reftoken) => {
          const ref = reftoken ? "&reftoken=" + reftoken : "";
          location.href = "/comparison.html?tokens=" + tokens.join(",") + ref;
        }
      };
    </script>
  </body>
</html>
